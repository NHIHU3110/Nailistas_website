<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S·∫£n ph·∫©m s∆°n m√≥ng | Nailistas</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="../../Login/auth.js" defer></script>

  
  <style>
    :root{--brand:#1935E1;--bg:#feffef;--ink:#222;--accent:#540D3E;--soft:#f5f5dc;--danger:#ff4d6d;}
    body{background:var(--bg);font-family:'Segoe UI',sans-serif;margin:0;}

    /* HEADER */
    header{position:fixed;top:0;left:0;right:0;z-index:1000;background:var(--brand);height:80px;
      display:flex;align-items:center;justify-content:space-between;padding:0 40px;box-sizing:border-box;}
    .nav-left{display:flex;gap:20px;align-items:center;}
    .logo-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;}
    .logo-center img{height:60px;cursor:pointer;transition:transform .4s ease;}
    .logo-center img:hover{transform:scale(1.1);}
    header a{position:relative;color:#fff;text-decoration:none;font-weight:500;font-size:1rem;}
    header a::after{content:"";position:absolute;bottom:-4px;left:50%;transform:translateX(-50%) scaleX(0);
      width:100%;height:2px;background:#fff;transition:transform .3s ease;}
    header a:hover::after,header a.active::after{transform:translateX(-50%) scaleX(1);}
    #cart-link{display:inline-flex;align-items:center;gap:8px;}
    .badge{min-width:22px;height:22px;padding:0 6px;background:#fff;color:var(--brand);
      border-radius:999px;font-size:12px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;}

    /* CONTENT OFFSET */
    main{padding-top:96px;}

    /* PAGE TRANSITION OVERLAY */
    #transition-overlay{position:fixed;inset:0;background:var(--brand);opacity:0;display:none;
      justify-content:center;align-items:center;transition:opacity .8s ease;z-index:2000;}

    /* Back btn */
    #back-button{position:fixed;top:100px;left:20px;background:transparent;border:none;cursor:pointer;width:42px;height:42px;z-index:999;}
    #back-button img{width:38px;height:38px;transition:transform .2s ease;}
    #back-button:hover img{transform:translateX(-3px);}

    h2{color:var(--brand);text-align:center;margin:24px 0 8px;}

    .filter-bar{width:90%;margin:10px auto 0;text-align:right;}
    select{padding:8px 12px;border:1px solid var(--brand);border-radius:6px;font-size:15px;cursor:pointer;background:#fff;}

    /* GRID */
    .product-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,280px));gap:25px;justify-content:center;width:100%;max-width:1200px;margin:25px auto;}
    .product-card{background:#fff;border:1px solid var(--soft);border-radius:16px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,.05);
      transition:transform .2s ease;cursor:pointer;width:280px;height:420px;display:flex;flex-direction:column;}
    .product-card:hover{transform:translateY(-5px);}
    .product-card img{width:100%;height:240px;object-fit:cover;border-bottom:1px solid #eee;cursor:pointer;}
    .product-info-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;}
    .product-details{text-align:left;}
    .product-details h3{margin:0;font-size:17px;color:#222;font-weight:600;}
    .product-details p{margin:6px 0 0;font-weight:600;color:#000;}
    .btn-cart{background:none;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .btn-cart img{width:24px;height:24px;transition:transform .3s ease;}
    .btn-cart:hover img{transform:scale(1.1);}

    #pagination{display:flex;justify-content:center;margin:30px 0;flex-wrap:wrap;gap:6px;}
    #pagination button{padding:6px 12px;border-radius:6px;border:1px solid var(--brand);background:#fff;color:var(--brand);cursor:pointer;}
    #pagination button.active,#pagination button:hover{background:var(--brand);color:#fff;}

    /* ==== CART DRAWER (s√°t m√©p ph·∫£i) ==== */
    #overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;visibility:hidden;transition:opacity .25s ease;z-index:1900;}
    #overlay.show{opacity:1;visibility:visible;}
    #cart-popup{position:fixed;top:80px;right:0;bottom:0;width:min(680px,92vw);background:#fff;border-left:1px solid #eee;
      border-radius:20px 0 0 20px;box-shadow:-12px 0 30px rgba(0,0,0,.18);transform:translateX(100%);opacity:0;transition:transform .28s ease,opacity .28s ease;z-index:2001;overflow:hidden;}
    #cart-popup.open{transform:translateX(0);opacity:1;}
    #cart-popup h3{margin:0;padding:16px 24px;text-align:center;color:var(--brand);font-size:22px;font-weight:700;border-bottom:1px solid #f0f0f0;background:#fff;}
    #cart-popup .close-btn{position:absolute;left:16px;top:14px;background:transparent;border:none;color:var(--brand);font-size:22px;cursor:pointer;line-height:1;}
    .cart-content{height:calc(100% - 160px);overflow:auto;padding:8px 24px 12px;}
    .cart-item{display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;padding:12px 0;border-bottom:1px solid #eee;}
    .cart-item:last-child{border-bottom:none;}
    .cart-item img{width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #eee;}
    .cart-item-info h4{margin:0;font-size:15px;color:#222;}
    .bottom-row{margin-top:6px;display:flex;align-items:center;gap:12px;}
    .bottom-row p{margin-left:auto;color:#222;font-weight:600;}
    .quantity-box{display:inline-flex;align-items:center;gap:8px;background:#e9eeff;padding:6px 8px;border-radius:8px;}
    .qty-btn{width:28px;height:28px;border-radius:6px;border:none;cursor:pointer;background:var(--brand);color:#fff;font-weight:700;}
    .qty-input{width:40px;height:28px;text-align:center;border:none;background:#fff;border-radius:6px;font-weight:700;}
    .remove-btn{background:none;border:none;color:var(--brand);cursor:pointer;font-size:18px;line-height:1;}
    .checkout-container{position:sticky;bottom:0;background:var(--brand);color:#fff;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:14px;border-top-left-radius:18px;}
    .checkout-text{font-weight:700;}
    .checkout-text span{display:block;margin-top:8px;font-size:26px;}
    .checkout-btn{padding:12px 18px;background:var(--danger);color:#fff;border:none;border-radius:12px;cursor:pointer;font-weight:700;
      box-shadow:0 0 0 rgba(255,77,109,0);transition:box-shadow .2s ease,transform .05s ease;}
    .checkout-btn:hover{box-shadow:0 0 24px rgba(255,77,109,.5);}
    .checkout-btn:active{transform:translateY(1px);}

    /* SCROLL TOP */
    #scrollTopBtn{position:fixed;bottom:30px;right:30px;background:var(--bg);border:1px solid #ddd;border-radius:12px;padding:10px;cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,.15);opacity:0;visibility:hidden;transition:opacity .4s ease,transform .3s ease,visibility .4s;z-index:9999;}
    #scrollTopBtn.show{opacity:1;visibility:visible;}
    #scrollTopBtn img{width:28px;height:28px;filter:brightness(0) saturate(100%) invert(13%) sepia(90%) saturate(2100%) hue-rotate(210deg);}
    #scrollTopBtn:hover{transform:scale(1.1);}

/* ---- Footer ---- */
footer {
  background-color: #1935E1;
  color: #fff8f0;
  padding: 40px 10%;
  text-align: center;
  animation: fadeInFooter 1s ease 0.5s both;
}
@keyframes fadeInFooter {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.footer-container {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 30px;
  margin-bottom: 25px;
}
.footer-section {
  flex: 1 1 250px;
}
.footer-section h3 {
  color: #ffb6c1;
  margin-bottom: 10px;
}
.footer-section a {
  color: #fff8f0;
  text-decoration: none;
}
.footer-section a:hover {
  opacity: 0.8;
}
.footer-bottom {
  border-top: 1px solid rgba(255,255,255,0.3);
  padding-top: 15px;
  font-size: 0.9rem;
}


@media (max-width:768px){#cart-popup{width:calc(100% - 8px);} .product-card{width:220px;height:360px;} .product-card img{height:200px;}}

        /*AVATAR ƒë·ªïi ƒëc*/
.account-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: #ccc; /* m√†u m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥ ·∫£nh */
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff; /* k√Ω t·ª± fallback */
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  overflow: hidden;
}

/* Header right: t√†i kho·∫£n, gi·ªè h√†ng, etc. */
.nav-right {
display: flex;
align-items: center; /* cƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
gap: 15px;
}

.account-avatar:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="nav-left">
      <a href="../../Blog/Blog.html">Blog</a>
      <a href="../../Booking/Booking.html">ƒê·∫∑t l·ªãch</a>
      <a href="../../Product/html/Product.html">S·∫£n ph·∫©m</a>
      <a href="../../Service/service.html">D·ªãch v·ª•</a>
    </div>
    <div class="logo-center">
        <img src="../../images/nail logo-01.png" alt="Logo Nailistas" onclick="goHome()">
    </div>
    <div class="nav-right">
      <a href="../../contact/contact.html" data-transition>Li√™n h·ªá</a>
      
      <a href="#" id="cart-link">Gi·ªè h√†ng <span id="cart-count" class="badge">0</span></a>
      <a href="../../Login/login.html" data-transition>ƒêƒÉng nh·∫≠p</a>
      <a href="#" data-auth="logout" style="display: none;">ƒêƒÉng xu·∫•t</a>
      <a href="../../Personal/personal.html" data-transition class="account-link">
        <div class="account-avatar" style="display:none;"></div>
      </a>
      
    </div>
  </header>

  <!-- Overlay chuy·ªÉn trang -->
  <div id="transition-overlay"></div>

  <!-- Back -->
  <button id="back-button" aria-label="Quay l·∫°i">
    <img src="../images/left_arrow.png" alt="Back" />
  </button>

  <main>
    <h2>S·∫¢N PH·∫®M S∆†N M√ìNG</h2>

    <div class="filter-bar">
      <label for="sortFilter">S·∫Øp x·∫øp theo:</label>
      <select id="sortFilter">
        <option value="az">T√™n (A ‚Üí Z)</option>
        <option value="za">T√™n (Z ‚Üí A)</option>
        <option value="priceAsc">Gi√° tƒÉng d·∫ßn</option>
        <option value="priceDesc">Gi√° gi·∫£m d·∫ßn</option>
      </select>
    </div>

    <div class="product-container" id="product-container" aria-live="polite"></div>
    <div id="pagination"></div>
  </main>

  <!-- CART DRAWER -->
  <div id="overlay"></div>
  <div id="cart-popup" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <button class="close-btn" aria-label="ƒê√≥ng">√ó</button>
    <h3 id="cartTitle">Gi·ªè h√†ng (<span id="cart-count-title">0</span>)</h3>
    <div class="cart-content" id="cart-content"></div>
    <div class="checkout-container">
      <div class="checkout-text">T·∫°m t√≠nh:<span id="cart-total-amount">0 VND</span></div>
      <button class="checkout-btn" id="checkout-btn">Thanh to√°n</button>
    </div>
  </div>

  <!-- Scroll top -->
  <button id="scrollTopBtn" title="L√™n ƒë·∫ßu trang"><img src="../images/up_arrow.png" alt="L√™n ƒë·∫ßu trang" /></button>

  <footer>
    <div class="footer-container">
      <div class="footer-section">
        <h3>H·ªá th·ªëng chi nh√°nh</h3>
        <p>üìç 12 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM</p>
        <p>üìç 25 L√Ω Th∆∞·ªùng Ki·ªát, H√† N·ªôi</p>
        <p>üìç 08 B·∫°ch ƒê·∫±ng, ƒê√† N·∫µng</p>
      </div>
      <div class="footer-section">
        <h3>Li√™n h·ªá</h3>
        <p>üìû Hotline: <strong>0909 888 777</strong></p>
        <p>üìß Email: <a href="mailto:contact@nailistas.vn">contact@nailistas.vn</a></p>
      </div>
      <div class="footer-section">
        <h3>Ch√≠nh s√°ch</h3>
        <p><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></p>
        <p><a href="#">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a></p>
      </div>
    </div>
    <hr />
    <p>&copy; Nailistas Vi·ªát Nam</p>
  </footer>
  <!-- üîµ N√∫t Facebook c·ªë ƒë·ªãnh -->
  <a href="https://www.facebook.com/share/1K7fcAhSu3/?mibextid=wwXIfr" 
    target="_blank" 
    class="facebook-fixed">
    <img src="../../images/fb.png" alt="Facebook Logo">
  </a>
  <!-- üîµ N√∫t g·ªçi ƒëi·ªán tho·∫°i c·ªë ƒë·ªãnh -->
  <a href="tel:+84366549188" class="phone-fixed">
    <img src="../../images/phone.webp" alt="Phone Icon">
  </a>
  <div id="overlay"></div>

  <script>

        const HOMEPAGE_URL = '../../Homepage/ck.html';

// üîπ Hi·ªÉn th·ªã overlay r·ªìi ƒëi·ªÅu h∆∞·ªõng (t·ª± s·ª≠a path v·ªÅ ƒë√∫ng Homepage n·∫øu c·∫ßn)
function showOverlayThenNavigate(url){
  // √âp m·ªçi URL ch·ª©a Homepage/ck.html v·ªÅ ƒë√∫ng ƒë∆∞·ªùng d·∫´n g·ªëc
  const target = (url && url.includes('../../Homepage/ck.html'))
    ? HOMEPAGE_URL
    : url;

  const ov = document.getElementById('transition-overlay');
  if (ov){
    ov.style.display = 'flex';
    ov.style.opacity = '1';
    setTimeout(()=>{ window.location.href = target; }, 600);
  } else {
    window.location.href = target;
  }
}
// üîπ Logo ‚Üí v·ªÅ trang ch·ªß v·ªõi overlay
// üîπ D√πng cho inline onclick="goHome()"
function goHome(){
  showOverlayThenNavigate(HOMEPAGE_URL);
}
// üìç Kh·ªüi t·∫°o logout popup khi trang load
window.addEventListener('load', () => {
  initLogoutPopup();
});

function initLogoutPopup() {
  // N·∫øu popup ƒë√£ t·ªìn t·∫°i th√¨ kh√¥ng c·∫ßn t·∫°o l·∫°i
  if (document.getElementById('logout-popup')) return;
  
  // üîπ T·∫°o ph·∫ßn t·ª≠ overlay
  const popup = document.createElement('div');
  popup.id = 'logout-popup';
  popup.className = 'logout-popup';
  popup.innerHTML = `
    <div class="logout-popup-content">
      <h3>B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?</h3>
      <div class="logout-popup-buttons">
        <button id="confirmLogout" class="btn-confirm">ƒêƒÉng xu·∫•t</button>
        <button id="cancelLogout" class="btn-cancel">H·ªßy</button>
      </div>
    </div>
  `;
  document.body.appendChild(popup);

  // üîπ Th√™m CSS tr·ª±c ti·∫øp b·∫±ng JS
  const style = document.createElement('style');
  style.textContent = `
    .logout-popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
    }
    .logout-popup-content {
      background: #fff;
      padding: 25px 35px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
      animation: popupFadeIn 0.3s ease;
    }
    .logout-popup-content h3 {
      margin-bottom: 15px;
      font-size: 18px;
      color: #333;
    }
    .logout-popup-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    .btn-confirm {
      background-color: #e53935;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-cancel {
      background-color: #ccc;
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-confirm:hover { background-color: #c62828; }
    .btn-cancel:hover { background-color: #b0b0b0; }
    @keyframes popupFadeIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);

  // üîπ G·∫Øn s·ª± ki·ªán cho n√∫t
  document.getElementById('cancelLogout').addEventListener('click', () => {
    popup.style.display = 'none';
  });

  document.getElementById('confirmLogout').addEventListener('click', () => {
    confirmLogout();
  });
}

function confirmLogout() {
  const popup = document.getElementById('logout-popup');
  popup.style.display = 'none';

  try {
    const Auth = window.AuthUtils;
    Auth?.logout?.();

    sessionStorage.removeItem('overlayShown');

    const accountText = document.querySelector('.account-text');
    const accountAvatar = document.querySelector('.account-avatar');
    if (accountText) accountText.style.display = 'none';
    if (accountAvatar) accountAvatar.style.display = 'none';
const loginLinks = document.querySelectorAll('a[href*="login.html"]');
    const logoutLinks = document.querySelectorAll('a[data-auth="logout"]');
    loginLinks.forEach(link => (link.style.display = 'block'));
    logoutLinks.forEach(link => (link.style.display = 'none'));

    const overlay = document.getElementById('transition-overlay');
    if (overlay) {
      overlay.style.display = 'flex';
      overlay.style.opacity = '1';
    }

    setTimeout(() => {
      window.location.href = "../../Homepage/ck.html";
    }, 800);
  } catch (error) {
    console.error('Logout error:', error);
    sessionStorage.removeItem('overlayShown');
    window.location.href = "../../Homepage/ck.html";
  }
}

// üîπ X·ª≠ l√Ω click tr√™n n√∫t logout
document.addEventListener('click', (e) => {
  const logoutBtn = e.target.closest('a[data-auth="logout"]');
  if (!logoutBtn) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  const popup = document.getElementById('logout-popup');
  popup.style.display = 'flex';
}, true);

// ‚ú® √Åp d·ª•ng hi·ªáu ·ª©ng overlay cho T·∫§T C·∫¢ c√°c th·∫ª <a> (TR·ª™ logout)
document.querySelectorAll('a[href]').forEach(link => {
  link.addEventListener('click', function(e) {
    const targetUrl = this.getAttribute('href');
    
    // ‚ùå B·ªé QUA n√∫t ƒëƒÉng xu·∫•t
    if (this.hasAttribute('data-auth') && this.getAttribute('data-auth') === 'logout') {
      return;
    }
    
    // B·ªè qua n·∫øu l√† li√™n k·∫øt # ho·∫∑c tel/mailto
    if (!targetUrl || targetUrl.startsWith('#') || targetUrl.startsWith('mailto:') || targetUrl.startsWith('tel:')) return;

    e.preventDefault();
    const overlay = document.getElementById('transition-overlay');
    overlay.style.display = 'flex';
    overlay.style.opacity = '1';
    setTimeout(() => {
      window.location.href = targetUrl;
    }, 800);
  });
});
    // ===== Helpers =====
    const overlayTrans = document.getElementById('transition-overlay');
    const productContainer = document.getElementById('product-container');
    const sortSelect = document.getElementById('sortFilter');
    const cartOverlay = document.getElementById('overlay');
    const cartPopup = document.getElementById('cart-popup');
    const cartContent = document.getElementById('cart-content');
    const cartTotalEl = document.getElementById('cart-total-amount');
    const cartCountTitle = document.getElementById('cart-count-title');
    const cartCountEl = document.getElementById('cart-count');
    const paginationEl = document.getElementById('pagination');

    const itemsPerPage = 15;
    let currentPage = 1;
    let entries = [];         // [ [id, product], ... ]
    let indexById = {};       // { id: product }

    const VND = n => (Number(n)||0).toLocaleString('vi-VN') + ' VND';
    const toNumber = x => typeof x === 'number' ? x : Number(String(x).replace(/[^0-9.-]/g,'')) || 0;

    // ===== Transitions =====
    
    const homeLogo = document.querySelector('.logo-center img');
    if (homeLogo) {
      homeLogo.addEventListener('click', goHome);}
    document.getElementById('back-button').onclick = ()=>{ if(document.referrer) history.back(); else window.location.href = 'Product.html'; };

    // Scroll top
    const scrollTopBtn = document.getElementById("scrollTopBtn");
    if (scrollTopBtn) {
      scrollTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) scrollTopBtn.classList.add('show');
        else scrollTopBtn.classList.remove('show');
      });
    }

    // ===== Cart (localStorage) =====
    const getCart = () => JSON.parse(localStorage.getItem('cart') || '[]');
    const setCart = (c) => localStorage.setItem('cart', JSON.stringify(c));
    const countCart = (c=getCart()) => c.reduce((s,it)=> s + (Number(it.quantity)||0), 0);
    const totalCart = (c=getCart()) => c.reduce((s,it)=> s + toNumber(it.price)*(Number(it.quantity)||0), 0);

    function renderCartBadge(){ const c=countCart(); cartCountEl.textContent = c>99?'99+':String(c); }

    function openCartPopup(){ renderCartPopup(); cartOverlay.classList.add('show'); cartPopup.classList.add('open'); }
    function closeCartPopup(){ cartPopup.classList.remove('open'); cartOverlay.classList.remove('show'); }

    cartOverlay.addEventListener('click', closeCartPopup);
    cartPopup.querySelector('.close-btn').addEventListener('click', closeCartPopup);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeCartPopup(); });

    // Header cart link opens drawer
    const headerCartLink = document.getElementById('cart-link');
    if (headerCartLink){
      headerCartLink.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); openCartPopup(); }, true);
    }

    function renderCartPopup(){
      const cart = getCart();
      cartContent.innerHTML = '';
      if(cart.length===0){
        cartContent.innerHTML = '<p style="padding:12px 24px;color:#666;">Gi·ªè h√†ng tr·ªëng.</p>';
        cartCountTitle.textContent = '0';
        cartTotalEl.textContent = VND(0);
        document.getElementById('checkout-btn').disabled = true;
        return;
      }
      document.getElementById('checkout-btn').disabled = false;

      cart.forEach(it=>{
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <img src="${it.img}" alt="${it.name}">
          <div class="cart-item-info">
            <h4>${it.name}</h4>
            <div class="bottom-row">
              <div class="quantity-box" data-id="${it.id}">
                <button class="qty-btn" data-action="dec">‚àí</button>
                <input type="number" class="qty-input" value="${it.quantity}" readonly/>
                <button class="qty-btn" data-action="inc">+</button>
              </div>
              <p>${VND(it.price)}</p>
            </div>
          </div>
          <button class="remove-btn" data-action="remove" data-id="${it.id}" title="X√≥a" aria-label="X√≥a">√ó</button>`;
        cartContent.appendChild(row);
      });
      cartCountTitle.textContent = String(countCart(cart));
      cartTotalEl.textContent = VND(totalCart(cart));
    }

    // Inc/Dec/Remove in drawer
    cartContent.addEventListener('click',(e)=>{
      const btn = e.target.closest('[data-action]'); if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id') || btn.parentElement.getAttribute('data-id');
      const cart = getCart(); const i = cart.findIndex(x=> String(x.id)===String(id)); if(i===-1) return;
      if(action==='inc') cart[i].quantity++;
      if(action==='dec') cart[i].quantity = Math.max(1, cart[i].quantity-1);
      if(action==='remove') cart.splice(i,1);
      setCart(cart); renderCartBadge(); renderCartPopup();
    });

    // Checkout (theo c·∫•u tr√∫c c·ªßa b·∫°n)
    // === Checkout ‚Üí chuy·ªÉn sang payment k√®m d·ªØ li·ªáu ===
(function () {
  const btn = document.getElementById('checkout-btn');
  if (!btn) return;

  const PAYMENT_URL = '../html/payment.html'; // ch·ªânh ƒë∆∞·ªùng d·∫´n n·∫øu kh√°c

  const toNumber = v => Number(String(v).replace(/[^\d.-]/g, '')) || 0;

  btn.addEventListener('click', (e) => {
    e.preventDefault();

    // 1) L·∫•y gi·ªè h√†ng t·ª´ localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    if (!cart.length) { alert('Gi·ªè h√†ng tr·ªëng!'); return; }

    // 2) ƒê√≥ng g√≥i payload
    const items = cart.map(({ id, name, price, quantity, img }) => ({
      id,
      name,
      unitPrice: toNumber(price),
      quantity: Number(quantity) || 1,
      imageSrc: img || ''
    }));
    const subtotal = items.reduce((s, i) => s + i.unitPrice * i.quantity, 0);
    const shipping = 15000;               // payment s·∫Ω t·ª± t√≠nh l·∫°i theo l·ª±a ch·ªçn
    const total = subtotal + shipping;
    const payload = {
      items, subtotal, shipping, total,
      currency: 'VND', locale: 'vi-VN', savedAt: new Date().toISOString()
    };

    // 3) Ghi v√†o sessionStorage + l∆∞u trang ngu·ªìn
    sessionStorage.setItem('checkoutData', JSON.stringify(payload));
    sessionStorage.setItem('paymentOrigin', location.href);

    // 4) ƒêi·ªÅu h∆∞·ªõng sang Payment
    window.location.href = PAYMENT_URL;
  });
})();

    // Sync across tabs
    window.addEventListener('storage', (e)=>{ if(e.key==='cart'){ renderCartBadge(); if(cartPopup.classList.contains('open')) renderCartPopup(); } });

    // ===== Products (type = 'polish') =====
    function sortEntries(list, type){
      const s=[...list];
      switch(type){
        case 'az': s.sort((a,b)=>a[1].name.localeCompare(b[1].name)); break;
        case 'za': s.sort((a,b)=>b[1].name.localeCompare(a[1].name)); break;
        case 'priceAsc': s.sort((a,b)=>toNumber(a[1].price)-toNumber(b[1].price)); break;
        case 'priceDesc': s.sort((a,b)=>toNumber(b[1].price)-toNumber(a[1].price)); break;
      }
      return s;
    }

    function renderProducts(page=1){
      productContainer.innerHTML='';
      const start=(page-1)*itemsPerPage, end=start+itemsPerPage;
      const pageItems=entries.slice(start,end);
      for(const [id,p] of pageItems){
        const card=document.createElement('div');
        card.className='product-card';
        card.innerHTML=`
          <img src="${p.img}" alt="${p.name}" data-href="Product_detail.html?id=${id}" class="prd-link">
          <div class="product-info-row">
            <div class="product-details">
              <h3>${p.name}</h3>
              <div class="product-stars" style="color:gold;font-size:20px;margin:5px 0;text-align:left;display:none"></div>
              <p>${VND(p.price)}</p>
            </div>
            <button class="btn-cart" data-id="${id}" title="Th√™m v√†o gi·ªè">
              <img src="../images/cart.png" alt="Cart">
            </button>
          </div>`;
        productContainer.appendChild(card);
      }
      renderPagination(page);
      renderAverageRatings();
    }

    function renderPagination(page){
      paginationEl.innerHTML='';
      const totalPages=Math.ceil(entries.length/itemsPerPage);
      for(let i=1;i<=totalPages;i++){
        const b=document.createElement('button'); b.textContent=i; if(i===page) b.classList.add('active');
        b.addEventListener('click',()=>{ currentPage=i; renderProducts(currentPage); });
        paginationEl.appendChild(b);
      }
    }

    // Delegated events
    productContainer.addEventListener('click',(e)=>{
      const cartBtn=e.target.closest('.btn-cart');
      const imgLink=e.target.closest('img.prd-link');
      if(cartBtn){
        const pid=cartBtn.getAttribute('data-id');
        const p=indexById[pid]; if(!p) return;
        const cart=getCart();
        const found=cart.find(it=>it.id===pid);
        if(found) found.quantity+=1;
        else cart.push({id:pid,name:p.name,price:toNumber(p.price),img:p.img,quantity:1});
        setCart(cart); renderCartBadge(); openCartPopup(); // m·ªü drawer, KH√îNG hi·ªán toast
      }
      if(imgLink){ showOverlayThenNavigate(imgLink.getAttribute('data-href')); }
    });

    // Ratings from localStorage
    function renderAverageRatings(){
      const ratings=JSON.parse(localStorage.getItem('ratings')||'{}');
      document.querySelectorAll('.product-card').forEach(card=>{
        const pid=card.querySelector('.btn-cart')?.getAttribute('data-id'); if(!pid) return;
        const avg=Math.max(0,Math.min(5,parseFloat(ratings[pid])||0));
        const full=Math.round(avg), stars='‚òÖ'.repeat(full)+'‚òÜ'.repeat(5-full);
        const box=card.querySelector('.product-stars');
        if(box){ box.style.display='block'; box.innerHTML=`${stars}<span style="color:#333;font-size:15px;margin-left:4px;">(${avg.toFixed(1)})</span>`; }
      });
    }
    window.addEventListener('storage',(e)=>{ if(e.key==='ratings') renderAverageRatings(); });

    sortSelect.addEventListener('change',()=>{ entries=sortEntries(entries,sortSelect.value); renderProducts(1); });

    // Boot
    fetch('../data/products.json')
      .then(r=>r.json())
      .then(products=>{
        const arr=Object.entries(products).filter(([_,p])=> p.type==='polish');
        arr.forEach(([id,p])=>{ p.price=toNumber(p.price); });
        entries=sortEntries(arr,'az');
        indexById=Object.fromEntries(entries);
        renderProducts(currentPage);
        renderCartBadge();
      })
      .catch(err=>{ console.error('L·ªói load s·∫£n ph·∫©m:',err); productContainer.innerHTML='<p style="color:#c00;text-align:center;">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch s·∫£n ph·∫©m.</p>'; });


    // === Reopen cart drawer when returning from payment ===
(function attachReopenCartListener(){
  function reopenIfNeeded(){
    if (sessionStorage.getItem('reopenCart') === '1') {
      sessionStorage.removeItem('reopenCart');

      // ƒë·ª£i 1 tick cho ch·∫Øc DOM drawer ƒë√£ s·∫µn s√†ng
      setTimeout(() => {
        // ∆∞u ti√™n d√πng h√†m chu·∫©n n·∫øu c√≥
        if (typeof openCartDrawer === 'function') {
          openCartDrawer();
          return;
        }

        // fallback 1: t·ª± th√™m class ƒë·ªÉ m·ªü drawer theo template
        const overlay = document.getElementById('overlay');
        const drawer  = document.getElementById('cart-drawer');
        if (overlay && drawer) {
          overlay.classList.add('show');
          drawer.classList.add('open');
          return;
        }

        // fallback 2: gi·∫£ l·∫≠p click v√†o link gi·ªè h√†ng
        document.getElementById('cart-link')
          ?.dispatchEvent(new MouseEvent('click', {bubbles:true, cancelable:true}));
      }, 0);
    }
  }

  // h·ªó tr·ª£ c·∫£ BFCache (pageshow) l·∫´n load th∆∞·ªùng
  window.addEventListener('pageshow', reopenIfNeeded);
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    reopenIfNeeded();
  } else {
    document.addEventListener('DOMContentLoaded', reopenIfNeeded, { once:true });
  }
})();

    /* =================== AUTH + LOGIN/LOGOUT =================== */

// üîπ Auth helper
window.AuthUtils = {
  // L·∫•y user hi·ªán t·∫°i
  getCurrentUser: function() {
    return JSON.parse(localStorage.getItem('currentUser')) || null;
  },

  // Login: l∆∞u user v√†o localStorage v√† c·∫≠p nh·∫≠t UI
  login: function(user) {
    localStorage.setItem('currentUser', JSON.stringify(user));
    updateAuthUI();
  },

  // Logout: x√≥a user v√† c·∫≠p nh·∫≠t UI
  logout: function() {
    localStorage.removeItem('currentUser');
    updateAuthUI();
  }
};

// üîπ C·∫≠p nh·∫≠t giao di·ªán theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
function updateAuthUI() {
  try {
    const Auth = window.AuthUtils;
    const user = Auth?.getCurrentUser?.();

    const loginLinks = document.querySelectorAll('a[href*="../Login/login.html"]');
    const logoutLinks = document.querySelectorAll('a[data-auth="logout"]');

    if (user) {
      // ƒê√É ƒëƒÉng nh·∫≠p -> ·∫®n "ƒêƒÉng nh·∫≠p", hi·ªán "ƒêƒÉng xu·∫•t"
      loginLinks.forEach(link => {
        if (link.closest('header')) link.style.display = 'none';
      });
      logoutLinks.forEach(link => link.style.display = 'block');
      console.log('User logged in:', user.name || user.email);
    } else {
      // CH∆ØA ƒëƒÉng nh·∫≠p -> Hi·ªán "ƒêƒÉng nh·∫≠p", ·∫®n "ƒêƒÉng xu·∫•t"
      loginLinks.forEach(link => {
        if (link.closest('header')) link.style.display = 'block';
      });
      logoutLinks.forEach(link => link.style.display = 'none');
      console.log('User not logged in');
    }
  } catch (error) {
    console.error('Error updating auth UI:', error);
    const loginLinks = document.querySelectorAll('a[href*="../Login/login.html"]');
    const logoutLinks = document.querySelectorAll('a[data-auth="logout"]');
    loginLinks.forEach(link => (link.style.display = 'block'));
    logoutLinks.forEach(link => (link.style.display = 'none'));
  }
}

// üîπ G·ªçi khi trang load
document.addEventListener('DOMContentLoaded', () => {
  updateAuthUI();
});

// üîπ Logout button handler
document.querySelectorAll('[data-auth="logout"]').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();

    // Hi·ªáu ·ª©ng overlay
    const overlay = document.getElementById('transition-overlay');
    if (overlay) {
      overlay.style.display = 'flex';
      overlay.style.opacity = '1';
    }

    // Logout th·ª±c s·ª±
    AuthUtils.logout();

    // Chuy·ªÉn v·ªÅ trang ch·ªß sau 800ms
    showOverlayThenNavigate(HOMEPAGE_URL);
  });
});

// üîπ ƒê·ªìng b·ªô UI khi localStorage thay ƒë·ªïi (tab kh√°c)
window.addEventListener('storage', (e) => {
  if (e.key === 'currentUser') {
    updateAuthUI();
  }
});

/* =================== Example Login Form Handler =================== */
/* Th√™m v√†o trang login.html */
const loginForm = document.getElementById('login-form');
if (loginForm) {
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const name = document.getElementById('name').value.trim();

    if (!email || !name) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
      return;
    }

    // L∆∞u user + c·∫≠p nh·∫≠t UI
    AuthUtils.login({ name, email });

    // Chuy·ªÉn v·ªÅ trang tr∆∞·ªõc ƒë√≥ ho·∫∑c home
     showOverlayThenNavigate(HOMEPAGE_URL);
  });
}

// Hi·ªáu ·ª©ng load trang khi m·ªõi v√†o
window.addEventListener('load', () => {
  document.body.classList.add('fade-in');
});


//C·∫¨P NH·∫¨T AVT//
function updateAuthUI() {
  const loginLinks  = document.querySelectorAll('a[href*="../Login/login.html"]');
  const logoutLinks = document.querySelectorAll('a[data-auth="logout"]');
  const accountAvatar = document.querySelector('.account-avatar');
  const accountText = document.querySelector('.account-text');

  const user = window.AuthUtils?.getCurrentUser?.();

  if (user) {
    loginLinks.forEach(link => link.style.display = 'none');
    logoutLinks.forEach(link => link.style.display = 'block');

    const avatarData = localStorage.getItem('user_avatar');
    if (accountAvatar) {
      if (avatarData) {
        accountAvatar.style.display = 'flex';
        accountAvatar.style.backgroundImage = `url(${avatarData})`;
        accountAvatar.textContent = '';
      } else {
        // fallback: hi·ªÉn th·ªã k√Ω t·ª± ƒë·∫ßu t√™n
        const firstChar = (user.name || user.email || '?')[0].toUpperCase();
        accountAvatar.style.display = 'flex';
        accountAvatar.style.backgroundImage = '';
        accountAvatar.textContent = firstChar;
      }
    }
    if (accountText) accountText.style.display = 'none';
  } else {
    loginLinks.forEach(link => link.style.display = 'block');
    logoutLinks.forEach(link => link.style.display = 'none');
    if (accountAvatar) accountAvatar.style.display = 'none';
    if (accountText) accountText.style.display = 'inline';
  }
}

// G·ªçi khi load trang
window.addEventListener('pageshow', updateAuthUI);
document.addEventListener('DOMContentLoaded', updateAuthUI);
  </script>
</body>
</html>
